name: Ubuntu 22 VM with sshx.io

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 4320   # Max 72 hours

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y qemu-kvm qemu-utils curl wget unzip git \
            vim net-tools iproute2 iputils-ping cloud-image-utils

      - name: Create Cloud-init Config
        run: |
          mkdir -p $HOME/vm
          cd $HOME/vm

          cat > user-data <<EOF
          #cloud-config
          password: root
          chpasswd: { expire: False }
          ssh_pwauth: True
          runcmd:
            - apt-get update -y
            - DEBIAN_FRONTEND=noninteractive apt-get install -y ufw
            - ufw --force reset
            - ufw default allow incoming
            - ufw default allow outgoing
            - ufw --force enable
            - sed -i 's/^#*PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
            - systemctl restart ssh || true
          EOF

          cat > meta-data <<EOF
          instance-id: iid-local01
          local-hostname: ubuntu-qemu
          EOF

          cloud-localds seed.img user-data meta-data

      - name: Download Ubuntu Image
        run: |
          cd $HOME/vm
          wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu22.img
          qemu-img resize ubuntu22.img 20G

      - name: Start VM
        run: |
          cd $HOME/vm
          nohup qemu-system-x86_64 \
            -enable-kvm \
            -m 4096 \
            -smp 2 \
            -cpu host \
            -drive file=ubuntu22.img,format=qcow2,if=virtio \
            -drive file=seed.img,format=raw,if=virtio \
            -netdev user,id=n0,hostfwd=tcp::2222-:22 \
            -device virtio-net-pci,netdev=n0 \
            -nographic -serial mon:stdio > vm.log 2>&1 &
          echo "‚úÖ VM starting..."
          sleep 60
          tail -n 30 vm.log || true

      - name: Run sshx.io
        run: |
          echo "==== Starting sshx.io ===="
          nohup bash -c "curl -sSf https://sshx.io/get | sh -s run" > $HOME/vm/sshx.log 2>&1 &
          sleep 8
          echo "==== sshx log (last 50 lines) ===="
          tail -n 50 $HOME/vm/sshx.log || true

      - name: Extract sshx URL
        run: |
          URL=$(grep -oE "https://sshx.io/[A-Za-z0-9]+" $HOME/vm/sshx.log | head -n1 || true)
          if [ -n "$URL" ]; then
            echo "‚úÖ SSHX URL: $URL"
            echo "üëâ Login: ssh root@<host> -p 2222 (password: root)"
          else
            echo "‚ö†Ô∏è sshx URL not found, check sshx.log manually"
            tail -n 100 $HOME/vm/sshx.log || true
          fi

      - name: Keep VM alive
        run: |
          echo "VM & sshx alive for 72 hours..."
          sleep 259200   # 72h max
