name: Playit VPS with SSH Access

on:
  workflow_dispatch:

jobs:
  playit-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Install Dependencies & Docker
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip net-tools sshpass
          # Install Docker using official script to avoid conflicts
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER
          docker --version

      - name: Start Ubuntu Container (VPS)
        run: |
          docker pull ubuntu:22.04
          docker run -d --name vps-playit \
            -p 2222:22 \
            --hostname ubuntu-vps \
            ubuntu:22.04 \
            bash -c "apt update -y && apt install -y openssh-server sudo wget unzip && \
                     mkdir /var/run/sshd && echo 'root:root' | chpasswd && \
                     sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
                     /usr/sbin/sshd -D"

      - name: Wait for SSH to be Ready
        run: |
          echo "Waiting for SSH..."
          for i in {1..30}; do
            nc -zv localhost 2222 && break
            echo "SSH not ready, retrying ($i/30)..."
            sleep 5
          done
          echo "‚úÖ SSH ready at root@localhost:2222 (password: root)"

      - name: Download Playit CLI
        run: |
          cd $HOME
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux.zip -O playit.zip
          unzip -o playit.zip -d $HOME/playit
          chmod +x $HOME/playit/playit

      - name: Start Playit Tunnel for SSH
        run: |
          nohup $HOME/playit/playit tunnel --name github-vps --proto tcp --port 2222 > $HOME/playit.log 2>&1 &
          sleep 15
          URL=$(grep -oE "https://[A-Za-z0-9]+\.playit\.live" $HOME/playit.log | head -n1)
          if [ -n "$URL" ]; then
            echo "‚úÖ Playit tunnel URL: $URL"
            echo "üëâ SSH login: ssh root@${URL#https://} -p 2222 (password: root)"
          else
            echo "‚ö†Ô∏è Playit tunnel not started, check playit.log"
          fi

      - name: Show Logs
        run: |
          tail -n 30 $HOME/playit.log
          docker logs vps-playit
