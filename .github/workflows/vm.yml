name: Playit VPS with SSHX Public Link

on:
  workflow_dispatch:

jobs:
  playit-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Install Docker
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          docker --version

      - name: Start Ubuntu Container with SSH
        run: |
          docker pull ubuntu:22.04
          docker run -d --name playit-container \
            -p 2222:22 \
            ubuntu:22.04 bash -c "\
              apt update -y && \
              apt install -y openssh-server wget unzip curl ca-certificates && \
              mkdir /var/run/sshd && echo 'root:root' | chpasswd && \
              sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
              /usr/sbin/sshd -D"

      - name: Wait for SSH
        run: |
          echo "Waiting for SSH..."
          for i in {1..30}; do
            nc -zv localhost 2222 && break
            echo "SSH not ready ($i/30)..."
            sleep 5
          done
          echo "✅ SSH ready at root@localhost:2222 (password: root)"

      - name: Run SSHX-style Playit Installer & Extract Public Link
        run: |
          sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@localhost bash <<'EOF'
curl -sSf https://sshx.io/get | sh -s run
sleep 10
URL=$(grep -oE "https://sshx.io/[A-Za-z0-9]+" /root/sshx.log | head -n1)
if [ -n "$URL" ]; then
  echo "✅ Public Link: $URL"
else
  echo "⚠️ Link not found, check /root/sshx.log"
fi
EOF

      - name: Show VPS Logs
        run: |
          docker logs playit-container
          sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@localhost "cat /root/sshx.log || true"
