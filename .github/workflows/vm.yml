name: VPS with SSHX Public Link

on:
  workflow_dispatch:

jobs:
  vps-sshx:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6h on GH runners

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y qemu-kvm qemu-utils cloud-image-utils wget curl sshpass net-tools

      - name: Setup VPS Directory
        run: |
          mkdir -p $HOME/vps
          cd $HOME/vps

      - name: Create Cloud-init Config
        run: |
          cd $HOME/vps
          cat > user-data <<EOF
#cloud-config
password: root
chpasswd: { expire: False }
ssh_pwauth: True
EOF

          cat > meta-data <<EOF
instance-id: iid-vps01
local-hostname: ubuntu-vps
EOF

          cloud-localds seed.img user-data meta-data

      - name: Download Ubuntu Image
        run: |
          cd $HOME/vps
          wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu22.qcow2
          qemu-img resize ubuntu22.qcow2 20G

      - name: Start VPS (KVM)
        run: |
          cd $HOME/vps
          nohup qemu-system-x86_64 \
            -enable-kvm \
            -cpu host \
            -m 4096 -smp 2 \
            -drive file=ubuntu22.qcow2,format=qcow2,if=virtio \
            -drive file=seed.img,format=raw,if=virtio \
            -netdev user,id=n0,hostfwd=tcp::2222-:22 \
            -device virtio-net-pci,netdev=n0 \
            -nographic -serial mon:stdio > vps.log 2>&1 &

          echo "Waiting for VPS SSH..."
          for i in {1..30}; do
            nc -zv localhost 2222 && break
            echo "SSH not ready yet, retrying..."
            sleep 10
          done
          echo "✅ VPS SSH is ready (root@localhost:2222)"

      - name: Run sshx.io inside VPS
        run: |
          sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@localhost bash <<'EOF'
echo "Starting sshx.io..."
nohup bash -c "curl -sSf https://sshx.io/get | sh -s run" > /root/sshx.log 2>&1 &
sleep 10
URL=$(grep -oE "https://sshx.io/[A-Za-z0-9]+" /root/sshx.log | head -n1)
if [ -n "$URL" ]; then
  echo "✅ Public SSHX link: $URL"
else
  echo "⚠️ SSHX link not found, check /root/sshx.log"
fi
EOF

      - name: Show VPS Log
        run: |
          tail -n 30 $HOME/vps/vps.log