name: Ubuntu 22 VM with sshx.io

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y qemu-kvm qemu-utils cloud-image-utils \
            curl wget unzip git vim net-tools iproute2 iputils-ping \
            python3 python3-pip build-essential ca-certificates ufw

      - name: Setup VM Image
        run: |
          mkdir -p $HOME/vm && cd $HOME/vm
          wget -q https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img -O ubuntu-cloud.img
          qemu-img resize ubuntu-cloud.img 30G

          cat > user-data <<'EOF'
#cloud-config
hostname: ubuntu22
manage_etc_hosts: true
disable_root: false
ssh_pwauth: true
chpasswd:
  list: |
    root:root
  expire: false
packages:
  - curl
  - wget
  - unzip
  - git
  - vim
  - net-tools
  - iproute2
  - iputils-ping
  - python3
  - python3-pip
  - build-essential
  - ca-certificates
  - ufw
runcmd:
  - ufw allow OpenSSH
  - ufw allow 80
  - ufw allow 443
  - ufw --force enable
  - sed -ri "s/^#?PermitRootLogin.*/PermitRootLogin yes/" /etc/ssh/sshd_config
  - systemctl restart ssh
  - curl -sSf https://sshx.io/get | sh -s run > /root/sshx.log 2>&1 &
EOF

          cat > meta-data <<'EOF'
instance-id: iid-local01
local-hostname: ubuntu22
EOF

          cloud-localds seed.iso user-data meta-data

      - name: Start VM
        run: |
          cd $HOME/vm
          nohup qemu-system-x86_64 \
            -enable-kvm \
            -m 4096 \
            -smp 4 \
            -cpu host \
            -drive file=ubuntu-cloud.img,format=qcow2,if=virtio \
            -drive file=seed.iso,format=raw,if=virtio \
            -boot order=c \
            -device virtio-net-pci,netdev=n0 \
            -netdev user,id=n0,hostfwd=tcp::2222-:22 \
            -nographic -serial mon:stdio > vm.log 2>&1 &
          sleep 90
          echo "âœ… VM started (sshx.io running inside)."

      - name: Show sshx URL
        run: |
          echo "==== sshx.io session URL ===="
          grep -m1 "https://sshx.io" $HOME/vm/ubuntu-cloud.img || true
          grep -m1 "https://sshx.io" $HOME/vm/vm.log || true
          echo "=============================="
