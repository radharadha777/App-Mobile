name: Playit VPS with SSH Access & Public Link

on:
  workflow_dispatch:

jobs:
  playit-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Install Dependencies & Docker
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip net-tools sshpass
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER
          docker --version

      - name: Start Ubuntu Container (VPS)
        run: |
          docker pull ubuntu:22.04
          docker run -d --name vps-playit \
            -p 2222:22 \
            --hostname ubuntu-vps \
            ubuntu:22.04 \
            bash -c "apt update -y && apt install -y openssh-server sudo wget unzip && \
                     mkdir /var/run/sshd && echo 'root:root' | chpasswd && \
                     sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
                     /usr/sbin/sshd -D"

      - name: Wait for SSH to be Ready
        run: |
          echo "Waiting for SSH..."
          for i in {1..30}; do
            nc -zv localhost 2222 && break
            echo "SSH not ready, retrying ($i/30)..."
            sleep 5
          done
          echo "✅ SSH ready at root@localhost:2222 (password: root)"

      - name: Run Playit Installer Script & Extract Public Link
        run: |
          sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@localhost bash -c "\
            bash <(curl -fsSL https://raw.githubusercontent.com/hopingboyz/playit/main/playit.sh) && \
            sleep 10 && \
            URL=\$(grep -oE 'https://playit.gg/[A-Za-z0-9]+' /root/playit.log | head -n1) && \
            if [ -n \"\$URL\" ]; then \
              echo '✅ Playit Public Link: ' \$URL; \
            else \
              echo '⚠️ Playit link not found, check /root/playit.log manually'; \
            fi"

      - name: Show VPS & Playit Logs
        run: |
          docker logs vps-playit
          echo "==== Check Playit log inside container ===="
          sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@localhost "cat /root/playit.log || true"
